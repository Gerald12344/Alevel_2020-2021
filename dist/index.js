"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _setupMultiplayer = require("./server/setupMultiplayer");

var _express = _interopRequireDefault(require("express"));

var _socket = require("socket.io");

var _setupLogger = require("./server/setupLogger");

var next = require("next");

var dev = process.env.DevOn == "false" ? false : true;
var apps = next({
  dev: true,
  dir: "."
});
var handle = apps.getRequestHandler();

var http = require("http");

var seed = Math.random();

var rug = require("random-username-generator");

var _PORT = process.env.PORT || 8080;

var games = [{
  id: 1,
  connectedClients: [],
  timeOfDay: 0
}];
var connectedClients = [];
(0, _setupMultiplayer.TestApp)();
var logger = (0, _setupLogger.SetupLogger)();
apps.prepare().then( /*#__PURE__*/(0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee() {
  var app, server, io, r;
  return _regenerator["default"].wrap(function _callee$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          app = (0, _express["default"])();
          server = http.createServer(app);
          io = new _socket.Server(server);

          r = function r() {
            return Math.random() * 256 >> 0;
          };

          io.on("connection", function (socket) {
            var data = {
              id: socket.id,
              color: "rgb(".concat(r(), ", ").concat(r(), ", ").concat(r(), ")"),
              name: rug.generate(),
              lastUpdate: Date.now(),
              pos: {
                x: 0,
                y: 0,
                z: 0
              },
              rot: {
                _x: 0,
                _y: 0,
                _z: 0
              }
            };
            connectedClients[Number(socket.id)] = data;
            io.emit("NewPlayer", socket.id, data);
            io.to(socket.id).emit("welcome", seed, connectedClients, data);
            socket.on("LocationUpdate", function (pos, rot) {
              if (typeof connectedClients[Number(socket.id)] !== "undefined") {
                connectedClients[Number(socket.id)].lastUpdate = Date.now();
                socket.broadcast.emit("PlayerLocationUpdate", socket.id, pos, rot, connectedClients[Number(socket.id)]);
              }
            });
            socket.on("sendChat", function (data) {
              io.emit("NewChat", connectedClients[Number(socket.id)], data);
            });
            socket.on("disconnect", function () {
              io.emit("LostPLayer", socket.id, false, connectedClients[Number(socket.id)]);
              delete connectedClients[Number(socket.id)];
            });
            var iid = setInterval(function () {
              if (typeof connectedClients[Number(socket.id)] === "undefined") {
                clearInterval(iid);
                return;
              }

              if (connectedClients[Number(socket.id)].lastUpdate < Date.now() - 5000) {
                io.emit("LostPLayer", socket.id, true, connectedClients[Number(socket.id)]);
                logger.info("Lost Player ".concat(socket.id));
                delete connectedClients[Number(socket.id)];
                io.to(socket.id).emit("Disconencted", true);
                clearInterval(iid);
              }
            }, 2000);
          });
          /*eslint complexity: ["error", 20]*/

          app.get("*", function (req, res) {
            if (!(req.url.includes("api") || req.url.includes("xml") || req.url.endsWith("login") || req.url.endsWith("logout"))) {
              return handle(req, res);
            }
          });
          server.listen(_PORT, function () {
            logger.info("listening on localhost:" + _PORT);
          });

        case 7:
        case "end":
          return _context.stop();
      }
    }
  }, _callee);
})))["catch"](function (ex) {
  logger.info(ex.stack);
  process.exit(1);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJuZXh0IiwicmVxdWlyZSIsImRldiIsInByb2Nlc3MiLCJlbnYiLCJEZXZPbiIsImFwcHMiLCJkaXIiLCJoYW5kbGUiLCJnZXRSZXF1ZXN0SGFuZGxlciIsImh0dHAiLCJzZWVkIiwiTWF0aCIsInJhbmRvbSIsInJ1ZyIsIl9QT1JUIiwiUE9SVCIsImdhbWVzIiwiaWQiLCJjb25uZWN0ZWRDbGllbnRzIiwidGltZU9mRGF5IiwibG9nZ2VyIiwicHJlcGFyZSIsInRoZW4iLCJhcHAiLCJzZXJ2ZXIiLCJjcmVhdGVTZXJ2ZXIiLCJpbyIsIlNlcnZlciIsInIiLCJvbiIsInNvY2tldCIsImRhdGEiLCJjb2xvciIsIm5hbWUiLCJnZW5lcmF0ZSIsImxhc3RVcGRhdGUiLCJEYXRlIiwibm93IiwicG9zIiwieCIsInkiLCJ6Iiwicm90IiwiX3giLCJfeSIsIl96IiwiTnVtYmVyIiwiZW1pdCIsInRvIiwiYnJvYWRjYXN0IiwiaWlkIiwic2V0SW50ZXJ2YWwiLCJjbGVhckludGVydmFsIiwiaW5mbyIsImdldCIsInJlcSIsInJlcyIsInVybCIsImluY2x1ZGVzIiwiZW5kc1dpdGgiLCJsaXN0ZW4iLCJleCIsInN0YWNrIiwiZXhpdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFGQSxJQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUlBLElBQU1DLEdBQUcsR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLEtBQVosSUFBcUIsT0FBckIsR0FBK0IsS0FBL0IsR0FBdUMsSUFBbkQ7QUFDQSxJQUFNQyxJQUFJLEdBQUdOLElBQUksQ0FBQztBQUFFRSxFQUFBQSxHQUFHLEVBQUMsSUFBTjtBQUFhSyxFQUFBQSxHQUFHLEVBQUM7QUFBakIsQ0FBRCxDQUFqQjtBQUNBLElBQU1DLE1BQU0sR0FBR0YsSUFBSSxDQUFDRyxpQkFBTCxFQUFmOztBQUVBLElBQU1D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O0FBQzFCekMsRUFBQUEsTUFBTSxDQUFDaUMsSUFBUCxDQUFZUSxFQUFFLENBQUNDLEtBQWY7QUFDQTVELEVBQUFBLE9BQU8sQ0FBQzZELElBQVIsQ0FBYSxDQUFiO0FBQ0gsQ0E3RkwiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IFRlc3RBcHAgfSBmcm9tIFwiLi9zZXJ2ZXIvc2V0dXBNdWx0aXBsYXllclwiO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIlxuXG5jb25zdCBuZXh0ID0gcmVxdWlyZShcIm5leHRcIik7XG5pbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tIFwic29ja2V0LmlvXCJcbmltcG9ydCB7IFNldHVwTG9nZ2VyIH0gZnJvbSBcIi4vc2VydmVyL3NldHVwTG9nZ2VyXCI7XG5cbmNvbnN0IGRldiA9IHByb2Nlc3MuZW52LkRldk9uID09IFwiZmFsc2VcIiA/IGZhbHNlIDogdHJ1ZTtcbmNvbnN0IGFwcHMgPSBuZXh0KHsgZGV2OnRydWUgLCBkaXI6XCIuXCJ9KTtcbmNvbnN0IGhhbmRsZSA9IGFwcHMuZ2V0UmVxdWVzdEhhbmRsZXIoKTtcblxuY29uc3QgaHR0cCA9IHJlcXVpcmUoXCJodHRwXCIpO1xuY29uc3Qgc2VlZCA9IE1hdGgucmFuZG9tKCk7XG52YXIgcnVnID0gcmVxdWlyZShcInJhbmRvbS11c2VybmFtZS1nZW5lcmF0b3JcIik7XG5cbmxldCBfUE9SVCA9IHByb2Nlc3MuZW52LlBPUlQgfHwgODA4MDtcblxubGV0IGdhbWVzID0gW1xuICAgIHtcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIGNvbm5lY3RlZENsaWVudHM6IFtdLFxuICAgICAgICB0aW1lT2ZEYXk6IDAsXG4gICAgfSxcbl07XG5sZXQgY29ubmVjdGVkQ2xpZW50czp7XG4gICAgaWQ6IFN0cmluZyxcbiAgICBjb2xvcjogIFN0cmluZyxcbiAgICBuYW1lOiBTdHJpbmcsXG4gICAgbGFzdFVwZGF0ZTogTnVtYmVyLFxuICAgIHBvczogeyB4OiBOdW1iZXIsIHk6IE51bWJlciwgejogTnVtYmVyfSxcbiAgICByb3Q6IHsgX3g6IE51bWJlciwgX3k6IE51bWJlciwgX3o6IE51bWJlciB9LFxufVtdID0gW107XG5cblRlc3RBcHAoKVxubGV0IGxvZ2dlciA9IFNldHVwTG9nZ2VyKClcblxuYXBwcy5wcmVwYXJlKClcbiAgICAudGhlbihhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCBhcHAgPSBleHByZXNzKCk7XG4gICAgICAgIGNvbnN0IHNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCk7XG5cbiAgICAgICAgY29uc3QgaW8gPSBuZXcgU2VydmVyKHNlcnZlcik7XG4gICAgICAgIHZhciByID0gKCkgPT4gKE1hdGgucmFuZG9tKCkgKiAyNTYpID4+IDA7XG5cbiAgICAgICAgaW8ub24oXCJjb25uZWN0aW9uXCIsIChzb2NrZXQpID0+IHtcbiAgICAgICAgICAgIGxldCBkYXRhID0ge1xuICAgICAgICAgICAgICAgIGlkOiBzb2NrZXQuaWQsXG4gICAgICAgICAgICAgICAgY29sb3I6IGByZ2IoJHtyKCl9LCAke3IoKX0sICR7cigpfSlgLFxuICAgICAgICAgICAgICAgIG5hbWU6IHJ1Zy5nZW5lcmF0ZSgpLFxuICAgICAgICAgICAgICAgIGxhc3RVcGRhdGU6IERhdGUubm93KCksXG4gICAgICAgICAgICAgICAgcG9zOiB7IHg6IDAsIHk6IDAsIHo6IDAgfSxcbiAgICAgICAgICAgICAgICByb3Q6IHsgX3g6IDAsIF95OiAwLCBfejogMCB9LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbm5lY3RlZENsaWVudHNbTnVtYmVyKHNvY2tldC5pZCldID0gZGF0YTtcbiAgICAgICAgICAgIGlvLmVtaXQoXCJOZXdQbGF5ZXJcIiwgc29ja2V0LmlkLCBkYXRhKTtcbiAgICAgICAgICAgIGlvLnRvKHNvY2tldC5pZCkuZW1pdChcIndlbGNvbWVcIiwgc2VlZCwgY29ubmVjdGVkQ2xpZW50cywgZGF0YSk7XG5cbiAgICAgICAgICAgIHNvY2tldC5vbihcIkxvY2F0aW9uVXBkYXRlXCIsIChwb3M6e30sIHJvdDp7fSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29ubmVjdGVkQ2xpZW50c1tOdW1iZXIoc29ja2V0LmlkKV0gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGVkQ2xpZW50c1tOdW1iZXIoc29ja2V0LmlkKV0ubGFzdFVwZGF0ZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5icm9hZGNhc3QuZW1pdChcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiUGxheWVyTG9jYXRpb25VcGRhdGVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3RlZENsaWVudHNbTnVtYmVyKHNvY2tldC5pZCldXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNvY2tldC5vbihcInNlbmRDaGF0XCIsIChkYXRhOlN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIGlvLmVtaXQoXCJOZXdDaGF0XCIsIGNvbm5lY3RlZENsaWVudHNbTnVtYmVyKHNvY2tldC5pZCldLCBkYXRhKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzb2NrZXQub24oXCJkaXNjb25uZWN0XCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICBpby5lbWl0KFxuICAgICAgICAgICAgICAgICAgICBcIkxvc3RQTGF5ZXJcIixcbiAgICAgICAgICAgICAgICAgICAgc29ja2V0LmlkLFxuICAgICAgICAgICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGVkQ2xpZW50c1tOdW1iZXIoc29ja2V0LmlkKV1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBjb25uZWN0ZWRDbGllbnRzW051bWJlcihzb2NrZXQuaWQpXTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgaWlkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29ubmVjdGVkQ2xpZW50c1tOdW1iZXIoc29ja2V0LmlkKV0gPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpaWQpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGVkQ2xpZW50c1tOdW1iZXIoc29ja2V0LmlkKV0ubGFzdFVwZGF0ZSA8XG4gICAgICAgICAgICAgICAgICAgIERhdGUubm93KCkgLSA1MDAwXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGlvLmVtaXQoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIkxvc3RQTGF5ZXJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0ZWRDbGllbnRzW051bWJlcihzb2NrZXQuaWQpXVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhgTG9zdCBQbGF5ZXIgJHtzb2NrZXQuaWR9YCk7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjb25uZWN0ZWRDbGllbnRzW051bWJlcihzb2NrZXQuaWQpXTtcbiAgICAgICAgICAgICAgICAgICAgaW8udG8oc29ja2V0LmlkKS5lbWl0KFwiRGlzY29uZW5jdGVkXCIsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGlpZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgMjAwMCk7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyplc2xpbnQgY29tcGxleGl0eTogW1wiZXJyb3JcIiwgMjBdKi9cbiAgICAgICAgYXBwLmdldChcIipcIiwgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgIShcbiAgICAgICAgICAgICAgICAgICAgcmVxLnVybC5pbmNsdWRlcyhcImFwaVwiKSB8fFxuICAgICAgICAgICAgICAgICAgICByZXEudXJsLmluY2x1ZGVzKFwieG1sXCIpIHx8XG4gICAgICAgICAgICAgICAgICAgIHJlcS51cmwuZW5kc1dpdGgoXCJsb2dpblwiKSB8fFxuICAgICAgICAgICAgICAgICAgICByZXEudXJsLmVuZHNXaXRoKFwibG9nb3V0XCIpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZShyZXEsIHJlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNlcnZlci5saXN0ZW4oX1BPUlQsICgpID0+IHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKFwibGlzdGVuaW5nIG9uIGxvY2FsaG9zdDpcIiArIF9QT1JUKTtcbiAgICAgICAgfSk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGV4OntzdGFjazpTdHJpbmd9KSA9PiB7XG4gICAgICAgIGxvZ2dlci5pbmZvKGV4LnN0YWNrKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH0pO1xuXG5cbiJdfQ==