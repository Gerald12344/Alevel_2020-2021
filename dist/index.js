"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _setupMultiplayer = require("./server/setupMultiplayer");

var _express = _interopRequireDefault(require("express"));

var _socket = require("socket.io");

var _setupLogger = require("./server/setupLogger");

var next = require("next");

var dev = process.env.DevOn == "false" ? false : true;
var apps = next({
  dev: false,
  dir: "."
});
var handle = apps.getRequestHandler();

var http = require("http");

var seed = Math.random();

var rug = require("random-username-generator");

var _PORT = process.env.PORT || 8080;

var games = [{
  id: 1,
  connectedClients: [],
  timeOfDay: 0
}];
var connectedClients = [];
(0, _setupMultiplayer.TestApp)();
var logger = (0, _setupLogger.SetupLogger)();
apps.prepare().then( /*#__PURE__*/(0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee() {
  var app, server, io, r;
  return _regenerator["default"].wrap(function _callee$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          app = (0, _express["default"])();
          server = http.createServer(app);
          io = new _socket.Server(server);

          r = function r() {
            return Math.random() * 256 >> 0;
          };

          io.on("connection", function (socket) {
            var data = {
              id: socket.id,
              color: "rgb(".concat(r(), ", ").concat(r(), ", ").concat(r(), ")"),
              name: rug.generate(),
              lastUpdate: Date.now(),
              pos: {
                x: 0,
                y: 0,
                z: 0
              },
              rot: {
                _x: 0,
                _y: 0,
                _z: 0
              }
            };
            connectedClients[Number(socket.id)] = data;
            io.emit("NewPlayer", socket.id, data);
            io.to(socket.id).emit("welcome", seed, connectedClients, data);
            socket.on("LocationUpdate", function (pos, rot) {
              if (typeof connectedClients[Number(socket.id)] !== "undefined") {
                connectedClients[Number(socket.id)].lastUpdate = Date.now();
                socket.broadcast.emit("PlayerLocationUpdate", socket.id, pos, rot, connectedClients[Number(socket.id)]);
              }
            });
            socket.on("sendChat", function (data) {
              io.emit("NewChat", connectedClients[Number(socket.id)], data);
            });
            socket.on("disconnect", function () {
              io.emit("LostPLayer", socket.id, false, connectedClients[Number(socket.id)]);
              delete connectedClients[Number(socket.id)];
            });
            var iid = setInterval(function () {
              if (typeof connectedClients[Number(socket.id)] === "undefined") {
                clearInterval(iid);
                return;
              }

              if (connectedClients[Number(socket.id)].lastUpdate < Date.now() - 5000) {
                io.emit("LostPLayer", socket.id, true, connectedClients[Number(socket.id)]);
                logger.info("Lost Player ".concat(socket.id));
                delete connectedClients[Number(socket.id)];
                io.to(socket.id).emit("Disconencted", true);
                clearInterval(iid);
              }
            }, 2000);
          });
          /*eslint complexity: ["error", 20]*/

          app.get("*", function (req, res) {
            if (!(req.url.includes("api") || req.url.includes("xml") || req.url.endsWith("login") || req.url.endsWith("logout"))) {
              return handle(req, res);
            }
          });
          server.listen(_PORT, function () {
            logger.info("listening on localhost:" + _PORT);
          });

        case 7:
        case "end":
          return _context.stop();
      }
    }
  }, _callee);
})))["catch"](function (ex) {
  logger.info(ex.stack);
  process.exit(1);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJuZXh0IiwicmVxdWlyZSIsImRldiIsInByb2Nlc3MiLCJlbnYiLCJEZXZPbiIsImFwcHMiLCJkaXIiLCJoYW5kbGUiLCJnZXRSZXF1ZXN0SGFuZGxlciIsImh0dHAiLCJzZWVkIiwiTWF0aCIsInJhbmRvbSIsInJ1ZyIsIl9QT1JUIiwiUE9SVCIsImdhbWVzIiwiaWQiLCJjb25uZWN0ZWRDbGllbnRzIiwidGltZU9mRGF5IiwibG9nZ2VyIiwicHJlcGFyZSIsInRoZW4iLCJhcHAiLCJzZXJ2ZXIiLCJjcmVhdGVTZXJ2ZXIiLCJpbyIsIlNlcnZlciIsInIiLCJvbiIsInNvY2tldCIsImRhdGEiLCJjb2xvciIsIm5hbWUiLCJnZW5lcmF0ZSIsImxhc3RVcGRhdGUiLCJEYXRlIiwibm93IiwicG9zIiwieCIsInkiLCJ6Iiwicm90IiwiX3giLCJfeSIsIl96IiwiTnVtYmVyIiwiZW1pdCIsInRvIiwiYnJvYWRjYXN0IiwiaWlkIiwic2V0SW50ZXJ2YWwiLCJjbGVhckludGVydmFsIiwiaW5mbyIsImdldCIsInJlcSIsInJlcyIsInVybCIsImluY2x1ZGVzIiwiZW5kc1dpdGgiLCJsaXN0ZW4iLCJleCIsInN0YWNrIiwiZXhpdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFDQTs7QUFDQTs7QUFHQTs7QUFDQTs7QUFGQSxJQUFNQSxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUlBLElBQU1DLEdBQUcsR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLEtBQVosSUFBcUIsT0FBckIsR0FBK0IsS0FBL0IsR0FBdUMsSUFBbkQ7QUFDQSxJQUFNQyxJQUFJLEdBQUdOLElBQUksQ0FBQztBQUFFRSxFQUFBQSxHQUFHLEVBQUMsS0FBTjtBQUFjSyxFQUFBQSxHQUFHLEVBQUM7QUFBbEIsQ0FBRCxDQUFqQjtBQUNBLElBQU1DLE1BQU0sR0FBR0YsSUFBSSxDQUFDRyxpQkFBTCxFQUFmOztBQUVBLElBQU1D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O0FBQzFCekMsRUFBQUEsTUFBTSxDQUFDaUMsSUFBUCxDQUFZUSxFQUFFLENBQUNDLEtBQWY7QUFDQTVELEVBQUFBLE9BQU8sQ0FBQzZELElBQVIsQ0FBYSxDQUFiO0FBQ0gsQ0E3RkwiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IFRlc3RBcHAgfSBmcm9tIFwiLi9zZXJ2ZXIvc2V0dXBNdWx0aXBsYXllclwiO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIlxuXG5jb25zdCBuZXh0ID0gcmVxdWlyZShcIm5leHRcIik7XG5pbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tIFwic29ja2V0LmlvXCJcbmltcG9ydCB7IFNldHVwTG9nZ2VyIH0gZnJvbSBcIi4vc2VydmVyL3NldHVwTG9nZ2VyXCI7XG5cbmNvbnN0IGRldiA9IHByb2Nlc3MuZW52LkRldk9uID09IFwiZmFsc2VcIiA/IGZhbHNlIDogdHJ1ZTtcbmNvbnN0IGFwcHMgPSBuZXh0KHsgZGV2OmZhbHNlICwgZGlyOlwiLlwifSk7XG5jb25zdCBoYW5kbGUgPSBhcHBzLmdldFJlcXVlc3RIYW5kbGVyKCk7XG5cbmNvbnN0IGh0dHAgPSByZXF1aXJlKFwiaHR0cFwiKTtcbmNvbnN0IHNlZWQgPSBNYXRoLnJhbmRvbSgpO1xudmFyIHJ1ZyA9IHJlcXVpcmUoXCJyYW5kb20tdXNlcm5hbWUtZ2VuZXJhdG9yXCIpO1xuXG5sZXQgX1BPUlQgPSBwcm9jZXNzLmVudi5QT1JUIHx8IDgwODA7XG5cbmxldCBnYW1lcyA9IFtcbiAgICB7XG4gICAgICAgIGlkOiAxLFxuICAgICAgICBjb25uZWN0ZWRDbGllbnRzOiBbXSxcbiAgICAgICAgdGltZU9mRGF5OiAwLFxuICAgIH0sXG5dO1xubGV0IGNvbm5lY3RlZENsaWVudHM6e1xuICAgIGlkOiBTdHJpbmcsXG4gICAgY29sb3I6ICBTdHJpbmcsXG4gICAgbmFtZTogU3RyaW5nLFxuICAgIGxhc3RVcGRhdGU6IE51bWJlcixcbiAgICBwb3M6IHsgeDogTnVtYmVyLCB5OiBOdW1iZXIsIHo6IE51bWJlcn0sXG4gICAgcm90OiB7IF94OiBOdW1iZXIsIF95OiBOdW1iZXIsIF96OiBOdW1iZXIgfSxcbn1bXSA9IFtdO1xuXG5UZXN0QXBwKClcbmxldCBsb2dnZXIgPSBTZXR1cExvZ2dlcigpXG5cbmFwcHMucHJlcGFyZSgpXG4gICAgLnRoZW4oYXN5bmMgKCkgPT4ge1xuICAgICAgICBsZXQgYXBwID0gZXhwcmVzcygpO1xuICAgICAgICBjb25zdCBzZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xuXG4gICAgICAgIGNvbnN0IGlvID0gbmV3IFNlcnZlcihzZXJ2ZXIpO1xuICAgICAgICB2YXIgciA9ICgpID0+IChNYXRoLnJhbmRvbSgpICogMjU2KSA+PiAwO1xuXG4gICAgICAgIGlvLm9uKFwiY29ubmVjdGlvblwiLCAoc29ja2V0KSA9PiB7XG4gICAgICAgICAgICBsZXQgZGF0YSA9IHtcbiAgICAgICAgICAgICAgICBpZDogc29ja2V0LmlkLFxuICAgICAgICAgICAgICAgIGNvbG9yOiBgcmdiKCR7cigpfSwgJHtyKCl9LCAke3IoKX0pYCxcbiAgICAgICAgICAgICAgICBuYW1lOiBydWcuZ2VuZXJhdGUoKSxcbiAgICAgICAgICAgICAgICBsYXN0VXBkYXRlOiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgIHBvczogeyB4OiAwLCB5OiAwLCB6OiAwIH0sXG4gICAgICAgICAgICAgICAgcm90OiB7IF94OiAwLCBfeTogMCwgX3o6IDAgfSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25uZWN0ZWRDbGllbnRzW051bWJlcihzb2NrZXQuaWQpXSA9IGRhdGE7XG4gICAgICAgICAgICBpby5lbWl0KFwiTmV3UGxheWVyXCIsIHNvY2tldC5pZCwgZGF0YSk7XG4gICAgICAgICAgICBpby50byhzb2NrZXQuaWQpLmVtaXQoXCJ3ZWxjb21lXCIsIHNlZWQsIGNvbm5lY3RlZENsaWVudHMsIGRhdGEpO1xuXG4gICAgICAgICAgICBzb2NrZXQub24oXCJMb2NhdGlvblVwZGF0ZVwiLCAocG9zOnt9LCByb3Q6e30pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbm5lY3RlZENsaWVudHNbTnVtYmVyKHNvY2tldC5pZCldICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RlZENsaWVudHNbTnVtYmVyKHNvY2tldC5pZCldLmxhc3RVcGRhdGUgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgICAgICAgICBzb2NrZXQuYnJvYWRjYXN0LmVtaXQoXG4gICAgICAgICAgICAgICAgICAgICAgICBcIlBsYXllckxvY2F0aW9uVXBkYXRlXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBwb3MsXG4gICAgICAgICAgICAgICAgICAgICAgICByb3QsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0ZWRDbGllbnRzW051bWJlcihzb2NrZXQuaWQpXVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzb2NrZXQub24oXCJzZW5kQ2hhdFwiLCAoZGF0YTpTdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICBpby5lbWl0KFwiTmV3Q2hhdFwiLCBjb25uZWN0ZWRDbGllbnRzW051bWJlcihzb2NrZXQuaWQpXSwgZGF0YSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgc29ja2V0Lm9uKFwiZGlzY29ubmVjdFwiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaW8uZW1pdChcbiAgICAgICAgICAgICAgICAgICAgXCJMb3N0UExheWVyXCIsXG4gICAgICAgICAgICAgICAgICAgIHNvY2tldC5pZCxcbiAgICAgICAgICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RlZENsaWVudHNbTnVtYmVyKHNvY2tldC5pZCldXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgY29ubmVjdGVkQ2xpZW50c1tOdW1iZXIoc29ja2V0LmlkKV07XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGlpZCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbm5lY3RlZENsaWVudHNbTnVtYmVyKHNvY2tldC5pZCldID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaWlkKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RlZENsaWVudHNbTnVtYmVyKHNvY2tldC5pZCldLmxhc3RVcGRhdGUgPFxuICAgICAgICAgICAgICAgICAgICBEYXRlLm5vdygpIC0gNTAwMFxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBpby5lbWl0KFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJMb3N0UExheWVyXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGVkQ2xpZW50c1tOdW1iZXIoc29ja2V0LmlkKV1cbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oYExvc3QgUGxheWVyICR7c29ja2V0LmlkfWApO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgY29ubmVjdGVkQ2xpZW50c1tOdW1iZXIoc29ja2V0LmlkKV07XG4gICAgICAgICAgICAgICAgICAgIGlvLnRvKHNvY2tldC5pZCkuZW1pdChcIkRpc2NvbmVuY3RlZFwiLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpaWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDIwMDApO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8qZXNsaW50IGNvbXBsZXhpdHk6IFtcImVycm9yXCIsIDIwXSovXG4gICAgICAgIGFwcC5nZXQoXCIqXCIsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICEoXG4gICAgICAgICAgICAgICAgICAgIHJlcS51cmwuaW5jbHVkZXMoXCJhcGlcIikgfHxcbiAgICAgICAgICAgICAgICAgICAgcmVxLnVybC5pbmNsdWRlcyhcInhtbFwiKSB8fFxuICAgICAgICAgICAgICAgICAgICByZXEudXJsLmVuZHNXaXRoKFwibG9naW5cIikgfHxcbiAgICAgICAgICAgICAgICAgICAgcmVxLnVybC5lbmRzV2l0aChcImxvZ291dFwiKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGUocmVxLCByZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBzZXJ2ZXIubGlzdGVuKF9QT1JULCAoKSA9PiB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcImxpc3RlbmluZyBvbiBsb2NhbGhvc3Q6XCIgKyBfUE9SVCk7XG4gICAgICAgIH0pO1xuICAgIH0pXG4gICAgLmNhdGNoKChleDp7c3RhY2s6U3RyaW5nfSkgPT4ge1xuICAgICAgICBsb2dnZXIuaW5mbyhleC5zdGFjayk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9KTtcblxuXG4iXX0=